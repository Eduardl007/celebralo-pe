<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="-WivQeeMjDJ48477slxQm1V3g5Z4kxukvV6vjRAfXcc" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Local | Cel√©bralo pe</title>
    <meta name="description" content="Informaci√≥n detallada del local para eventos">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Leaflet CSS para mapa interactivo -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <style>
        .local-page {
            padding-top: var(--header-height);
        }

        /* Gallery */
        .gallery-section {
            background: var(--gray-100);
            padding: var(--spacing-4) 0;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--spacing-3);
            max-height: 480px;
        }

        .gallery-main {
            position: relative;
            border-radius: var(--radius-xl);
            overflow: hidden;
            cursor: pointer;
        }

        .gallery-main img,
        .gallery-main .placeholder {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-main .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .gallery-side {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: var(--spacing-3);
        }

        .gallery-thumb {
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
        }

        .gallery-thumb img,
        .gallery-thumb .placeholder {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-thumb .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
        }

        .gallery-more {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
        }

        /* Content Layout */
        .local-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: var(--spacing-8);
            padding: var(--spacing-8) 0;
        }

        /* Main Info */
        .local-main {
            min-width: 0;
        }

        .local-header {
            margin-bottom: var(--spacing-6);
        }

        .local-badges {
            display: flex;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-3);
        }

        .local-title {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--spacing-2);
        }

        .local-location {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            color: var(--text-secondary);
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-4);
        }

        .local-location i {
            color: var(--primary);
        }

        .local-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-6);
            padding: var(--spacing-4);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .meta-item i {
            color: var(--primary);
            font-size: var(--font-size-lg);
        }

        .meta-item strong {
            color: var(--text-primary);
        }

        .meta-item span {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Sections */
        .info-section {
            margin-bottom: var(--spacing-8);
        }

        .info-section h2 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--spacing-4);
            padding-bottom: var(--spacing-3);
            border-bottom: 2px solid var(--border-light);
        }

        .description {
            color: var(--text-secondary);
            line-height: var(--line-height-relaxed);
        }

        /* Amenities Grid */
        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-4);
        }

        .amenity-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }

        .amenity-item i {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-50);
            color: var(--primary);
            border-radius: var(--radius-md);
        }

        .amenity-item span {
            font-size: var(--font-size-sm);
            color: var(--text-primary);
        }

        /* Availability */
        .availability-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--spacing-2);
        }

        .day-slot {
            text-align: center;
            padding: var(--spacing-3);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        .day-slot.available {
            background: var(--success-50);
            color: var(--success);
        }

        .day-slot.unavailable {
            background: var(--gray-100);
            color: var(--text-muted);
        }

        .day-slot .day-name {
            font-weight: var(--font-weight-semibold);
            display: block;
            margin-bottom: var(--spacing-1);
        }

        .day-slot .hours {
            font-size: var(--font-size-xs);
        }

        /* Reviews */
        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-5);
        }

        .rating-summary {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
        }

        .rating-big {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .rating-details {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-1);
        }

        .rating-stars {
            color: var(--accent);
        }

        .review-card {
            padding: var(--spacing-5);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-4);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-3);
        }

        .review-author {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .review-text {
            color: var(--text-secondary);
            line-height: var(--line-height-relaxed);
        }

        /* Owner Card */
        .owner-card {
            padding: var(--spacing-5);
            background: var(--gray-50);
            border-radius: var(--radius-xl);
            margin-top: var(--spacing-6);
        }

        .owner-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-4);
        }

        .owner-avatar {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-full);
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .owner-info h4 {
            margin-bottom: var(--spacing-1);
        }

        .owner-info p {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin: 0;
        }

        .owner-stats {
            display: flex;
            gap: var(--spacing-6);
            padding: var(--spacing-3) 0;
            border-top: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
            margin-bottom: var(--spacing-4);
        }

        .owner-stats div {
            text-align: center;
        }

        .owner-stats strong {
            display: block;
            font-size: var(--font-size-lg);
            color: var(--text-primary);
        }

        .owner-stats span {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        /* Sidebar */
        .local-sidebar {
            position: sticky;
            top: calc(var(--header-height) + var(--spacing-4));
            height: fit-content;
        }

        .booking-card {
            background: var(--white);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-6);
            border: 1px solid var(--border-light);
        }

        .booking-price {
            display: flex;
            align-items: baseline;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-5);
        }

        .booking-price .amount {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--primary);
        }

        .booking-price .note {
            color: var(--text-muted);
        }

        .booking-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-4);
        }

        .booking-form label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--spacing-1);
            display: block;
        }

        .price-breakdown {
            padding: var(--spacing-4);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            margin: var(--spacing-4) 0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-2) 0;
            font-size: var(--font-size-sm);
        }

        .price-row.total {
            border-top: 1px solid var(--border-light);
            margin-top: var(--spacing-2);
            padding-top: var(--spacing-3);
            font-weight: var(--font-weight-semibold);
        }

        .price-row.total span:last-child {
            color: var(--primary);
            font-size: var(--font-size-lg);
        }

        .booking-actions {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }

        .share-actions {
            display: flex;
            justify-content: center;
            gap: var(--spacing-4);
            margin-top: var(--spacing-4);
            padding-top: var(--spacing-4);
            border-top: 1px solid var(--border-light);
        }

        .share-actions button {
            padding: var(--spacing-2);
            color: var(--text-muted);
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .share-actions button:hover {
            color: var(--primary);
        }

        /* Policies */
        .policies-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }

        .policy-item {
            display: flex;
            gap: var(--spacing-3);
            padding: var(--spacing-3);
            background: var(--gray-50);
            border-radius: var(--radius-md);
        }

        .policy-item i {
            color: var(--success);
            margin-top: 2px;
        }

        .policy-item p {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin: 0;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .local-content {
                grid-template-columns: 1fr;
            }

            .local-sidebar {
                position: static;
            }

            .gallery-grid {
                grid-template-columns: 1fr;
                max-height: none;
            }

            .gallery-main {
                height: 300px;
            }

            .gallery-side {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto;
                height: 150px;
            }

            .amenities-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .availability-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .amenities-grid {
                grid-template-columns: 1fr 1fr;
            }

            .availability-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .local-meta {
                flex-direction: column;
                gap: var(--spacing-3);
            }
        }

        /* Mapa interactivo */
        .map-section {
            margin-bottom: var(--spacing-8);
        }

        .map-container {
            height: 300px;
            border-radius: var(--radius-xl);
            overflow: hidden;
            border: 2px solid var(--border-light);
        }

        .map-actions {
            display: flex;
            gap: var(--spacing-3);
            margin-top: var(--spacing-3);
        }

        .map-actions .btn {
            flex: 1;
        }

        /* Sistema de rese√±as mejorado */
        .write-review-section {
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--secondary-50) 100%);
            border: 2px dashed var(--primary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-6);
            margin-bottom: var(--spacing-6);
            text-align: center;
        }

        .write-review-section h4 {
            margin-bottom: var(--spacing-2);
            color: var(--primary);
        }

        .write-review-section p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-4);
        }

        .review-form {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-6);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing-6);
        }

        .review-form h4 {
            margin-bottom: var(--spacing-4);
        }

        .star-rating-input {
            display: flex;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
            justify-content: center;
        }

        .star-rating-input i {
            font-size: 2rem;
            color: var(--gray-300);
            cursor: pointer;
            transition: all 0.2s;
        }

        .star-rating-input i:hover,
        .star-rating-input i.active {
            color: var(--accent);
            transform: scale(1.1);
        }

        .review-form textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--spacing-4);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            resize: vertical;
            font-family: inherit;
            margin-bottom: var(--spacing-4);
        }

        .review-form textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .review-helpful {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-top: var(--spacing-3);
            padding-top: var(--spacing-3);
            border-top: 1px solid var(--border-light);
        }

        .review-helpful span {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
        }

        .review-helpful button {
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
            padding: var(--spacing-1) var(--spacing-3);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-full);
            background: var(--white);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .review-helpful button:hover {
            background: var(--gray-50);
            border-color: var(--primary);
            color: var(--primary);
        }

        .review-helpful button.active {
            background: var(--primary-50);
            border-color: var(--primary);
            color: var(--primary);
        }

        .all-reviews-list {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Modal de rese√±as */
        .review-modal-content {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #reviewModal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        #reviewModal .auth-header {
            position: sticky;
            top: 0;
            background: var(--white);
            padding-bottom: var(--spacing-4);
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="app" class="local-page">
        <!-- Header -->
        <header class="header" id="header">
            <div class="container">
                <nav class="nav">
                    <a href="../index.html" class="logo">
                        <span class="logo-icon">üéâ</span>
                        <span class="logo-text">Cel√©bralo pe</span>
                        <span class="logo-badge">Per√∫</span>
                    </a>
                    <ul class="nav-menu" id="navMenu">
                        <li><a href="../index.html" class="nav-link">Inicio</a></li>
                        <li><a href="locales.html" class="nav-link active">Locales</a></li>
                        <li><a href="servicios.html" class="nav-link">Servicios</a></li>
                        <li><a href="paquetes.html" class="nav-link">Paquetes</a></li>
                    </ul>
                    <div class="nav-actions">
                        <button class="btn btn-ghost" onclick="openAuthModal('login')">
                            <i class="fas fa-user"></i>
                            <span>Ingresar</span>
                        </button>
                        <button class="nav-toggle" id="navToggle" aria-label="Men√∫">
                            <span></span><span></span><span></span>
                        </button>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Gallery Section -->
        <section class="gallery-section">
            <div class="container">
                <div class="gallery-grid" id="galleryGrid">
                    <!-- Gallery loaded via JS -->
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <div class="container">
            <div class="local-content">
                <!-- Main Info -->
                <main class="local-main" id="localMain">
                    <!-- Content loaded via JS -->
                </main>

                <!-- Sidebar -->
                <aside class="local-sidebar">
                    <div class="booking-card" id="bookingCard">
                        <!-- Booking form loaded via JS -->
                    </div>
                </aside>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-bottom" style="border: none; padding: var(--spacing-6) 0;">
                    <p>&copy; 2025 Cel√©bralo pe. Todos los derechos reservados.</p>
                </div>
            </div>
        </footer>

        <!-- Chatbot -->
        <div class="chatbot" id="chatbot">
            <button class="chatbot-trigger" id="chatbotTrigger"><i class="fas fa-comments"></i></button>
            <div class="chatbot-window" id="chatbotWindow">
                <div class="chatbot-header">
                    <div class="chatbot-avatar"><img src="../assets/images/eventbot-avatar.svg" alt="Cel√©"><span class="status-dot"></span></div>
                    <div class="chatbot-info"><strong>Cel√©</strong><span>Tu asistente festivo üéâ</span></div>
                    <button class="chatbot-close" id="chatbotClose"><i class="fas fa-times"></i></button>
                </div>
                <div class="chatbot-messages" id="chatbotMessages"></div>
                <div class="chatbot-quick-actions" id="quickActions">
                    <button class="quick-action" data-action="precios">üí∞ Precios</button>
                    <button class="quick-action" data-action="disponibilidad">üìÖ Disponibilidad</button>
                </div>
                <form class="chatbot-input" id="chatbotForm">
                    <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." autocomplete="off">
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>

        <!-- Auth Modal -->
        <div class="modal" id="authModal">
            <div class="modal-overlay"></div>
            <div class="modal-content auth-modal">
                <button class="modal-close" aria-label="Cerrar"><i class="fas fa-times"></i></button>
                <div class="auth-form" id="loginForm">
                    <div class="auth-header">
                        <h2>Bienvenido de vuelta</h2>
                        <p>Ingresa a tu cuenta para continuar</p>
                    </div>
                    <form id="loginFormElement">
                        <div class="form-group">
                            <label for="loginEmail">Correo electr√≥nico</label>
                            <div class="input-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="loginEmail" placeholder="tu@correo.com" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Contrase√±a</label>
                            <div class="input-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block btn-lg">Ingresar</button>
                    </form>
                    <p class="auth-switch">¬øNo tienes cuenta? <a href="#" onclick="switchAuthForm('register')">Reg√≠strate</a></p>
                </div>
                <div class="auth-form hidden" id="registerForm">
                    <div class="auth-header">
                        <h2>Crea tu cuenta</h2>
                        <p>√önete a Cel√©bralo pe</p>
                    </div>
                    <form id="registerFormElement">
                        <div class="form-row-2">
                            <div class="form-group">
                                <label for="registerName">Nombre</label>
                                <input type="text" id="registerName" placeholder="Tu nombre" required>
                            </div>
                            <div class="form-group">
                                <label for="registerLastname">Apellido</label>
                                <input type="text" id="registerLastname" placeholder="Tu apellido" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">Correo electr√≥nico</label>
                            <div class="input-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="registerEmail" placeholder="tu@correo.com" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="registerPhone">Tel√©fono</label>
                            <div class="input-icon">
                                <i class="fas fa-phone"></i>
                                <input type="tel" id="registerPhone" placeholder="999 888 777" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">Contrase√±a</label>
                            <div class="input-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="registerPassword" placeholder="M√≠nimo 8 caracteres" required>
                            </div>
                        </div>
                        <label class="checkbox">
                            <input type="checkbox" id="acceptTerms" required>
                            <span>Acepto los <a href="terminos-condiciones.html">T√©rminos y Condiciones</a> y la <a href="politica-privacidad.html">Pol√≠tica de Privacidad</a></span>
                        </label>
                        <button type="submit" class="btn btn-primary btn-block btn-lg">Crear cuenta</button>
                    </form>
                    <p class="auth-switch">¬øYa tienes cuenta? <a href="#" onclick="switchAuthForm('login')">Inicia sesi√≥n</a></p>
                </div>
            </div>
        </div>

        <div class="toast-container" id="toastContainer"></div>

        <!-- Modal de Solicitud de Reserva -->
        <div class="modal" id="bookingModal">
            <div class="modal-overlay" onclick="closeBookingModal()"></div>
            <div class="modal-content auth-modal">
                <button class="modal-close" onclick="closeBookingModal()" aria-label="Cerrar"><i class="fas fa-times"></i></button>
                <div class="auth-header">
                    <h2><i class="fas fa-calendar-check" style="color: var(--primary); margin-right: 8px;"></i>Solicitar Reserva</h2>
                    <p id="bookingModalSubtitle">Completa tus datos y te contactaremos en menos de 24 horas</p>
                </div>
                <form id="bookingRequestForm" onsubmit="submitBookingRequest(event)">
                    <div class="booking-summary" style="background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 id="modalLocalName" style="margin: 0 0 8px 0; color: var(--gray-900);"></h4>
                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 14px; color: var(--gray-600);">
                            <span><i class="fas fa-calendar"></i> <span id="modalDate"></span></span>
                            <span><i class="fas fa-users"></i> <span id="modalGuests"></span> invitados</span>
                            <span><i class="fas fa-tag"></i> <span id="modalEventType"></span></span>
                        </div>
                        <div style="margin-top: 12px; font-size: 18px; font-weight: 600; color: var(--primary);">
                            Total estimado: <span id="modalTotal"></span>
                        </div>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group">
                            <label for="bookingName">Nombre completo *</label>
                            <input type="text" id="bookingName" placeholder="Tu nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="bookingPhone">Tel√©fono / WhatsApp *</label>
                            <input type="tel" id="bookingPhone" placeholder="999 888 777" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bookingEmail">Correo electr√≥nico *</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="bookingEmail" placeholder="tu@correo.com" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bookingMessage">Mensaje adicional (opcional)</label>
                        <textarea id="bookingMessage" rows="3" placeholder="¬øTienes alguna pregunta o requerimiento especial?" style="width: 100%; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="submitBookingBtn">
                        <i class="fas fa-paper-plane"></i> Enviar Solicitud de Reserva
                    </button>
                    <p style="text-align: center; margin-top: 12px; font-size: 13px; color: var(--gray-500);">
                        <i class="fas fa-shield-alt"></i> Tus datos est√°n protegidos. Te contactaremos pronto.
                    </p>
                </form>
            </div>
        </div>

        <!-- Modal de Solicitar Visita -->
        <div class="modal" id="visitModal">
            <div class="modal-overlay" onclick="closeVisitModal()"></div>
            <div class="modal-content auth-modal">
                <button class="modal-close" onclick="closeVisitModal()" aria-label="Cerrar"><i class="fas fa-times"></i></button>
                <div class="auth-header">
                    <h2><i class="fas fa-eye" style="color: var(--primary); margin-right: 8px;"></i>Solicitar Visita</h2>
                    <p>Agenda una visita para conocer el local en persona</p>
                </div>
                <form id="visitRequestForm" onsubmit="submitVisitRequest(event)">
                    <div class="form-row-2">
                        <div class="form-group">
                            <label for="visitName">Nombre completo *</label>
                            <input type="text" id="visitName" placeholder="Tu nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="visitPhone">Tel√©fono / WhatsApp *</label>
                            <input type="tel" id="visitPhone" placeholder="999 888 777" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="visitEmail">Correo electr√≥nico *</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="visitEmail" placeholder="tu@correo.com" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="visitPreferredDate">Fecha preferida para visita</label>
                        <input type="date" id="visitPreferredDate" style="width: 100%; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px;">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="submitVisitBtn">
                        <i class="fas fa-calendar-plus"></i> Solicitar Visita
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal para escribir rese√±a -->
        <div class="modal" id="reviewModal">
            <div class="modal-overlay" onclick="closeReviewModal()"></div>
            <div class="modal-content auth-modal review-modal-content">
                <button class="modal-close" onclick="closeReviewModal()" aria-label="Cerrar"><i class="fas fa-times"></i></button>
                <div class="auth-header">
                    <h2><i class="fas fa-star" style="color: var(--accent); margin-right: 8px;"></i>Escribe tu rese√±a</h2>
                    <p id="reviewModalSubtitle">Comparte tu experiencia en este local</p>
                </div>
                <form id="reviewForm" onsubmit="submitReview(event)">
                    <div class="form-group" style="text-align: center;">
                        <label style="display: block; margin-bottom: 12px;">¬øC√≥mo calificar√≠as tu experiencia?</label>
                        <div class="star-rating-input" id="starRatingInput">
                            <i class="far fa-star" data-rating="1"></i>
                            <i class="far fa-star" data-rating="2"></i>
                            <i class="far fa-star" data-rating="3"></i>
                            <i class="far fa-star" data-rating="4"></i>
                            <i class="far fa-star" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="reviewRating" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="reviewEventType">¬øQu√© tipo de evento celebraste?</label>
                        <select id="reviewEventType" required style="width: 100%; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px;">
                            <option value="">Selecciona...</option>
                            <option value="Matrimonio">üíí Matrimonio</option>
                            <option value="Quincea√±os">üëë Quincea√±os</option>
                            <option value="Cumplea√±os">üéÇ Cumplea√±os</option>
                            <option value="Bautizo">üë∂ Bautizo</option>
                            <option value="Corporativo">üè¢ Evento Corporativo</option>
                            <option value="Graduaci√≥n">üéì Graduaci√≥n</option>
                            <option value="Otro">üéâ Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reviewComment">Cu√©ntanos tu experiencia</label>
                        <textarea id="reviewComment" placeholder="¬øQu√© te gust√≥ del local? ¬øC√≥mo fue el servicio? ¬øLo recomendar√≠as?" required></textarea>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group">
                            <label for="reviewName">Tu nombre</label>
                            <input type="text" id="reviewName" placeholder="Tu nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="reviewEmail">Correo (no se publicar√°)</label>
                            <input type="email" id="reviewEmail" placeholder="tu@correo.com" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="submitReviewBtn">
                        <i class="fas fa-paper-plane"></i> Publicar Rese√±a
                    </button>
                    <p style="text-align: center; margin-top: 12px; font-size: 13px; color: var(--gray-500);">
                        <i class="fas fa-shield-alt"></i> Tu rese√±a ser√° revisada antes de publicarse
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        const EMAILJS_PUBLIC_KEY = '0dYuscUBKL8b-TRsX';
        const EMAILJS_SERVICE_ID = 'service_ealwt3e';
        const EMAILJS_TEMPLATE_ID = 'template_x0x0gnu';
        emailjs.init(EMAILJS_PUBLIC_KEY);
    </script>

    <!-- Google Sheets Integration -->
    <script>
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbx-Jyco4e_8mvT2stR39kU-vKEaDxvdd6FDosumVFW2ufMNwcrBLM3JEQGr44C5Ajl3/exec';

        async function sendToGoogleSheets(sheetName, data) {
            console.log('Enviando a Google Sheets:', sheetName, data);

            try {
                // M√©todo 1: Fetch con POST (preferido)
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sheet: sheetName,
                        data: data
                    })
                });

                console.log('Datos enviados correctamente a:', sheetName);
                return true;

            } catch (error) {
                console.error('Error con fetch, intentando m√©todo alternativo:', error);

                // M√©todo 2: Fallback con imagen (m√°s compatible)
                try {
                    const params = new URLSearchParams({ sheet: sheetName, ...data });
                    const img = new Image();
                    img.src = GOOGLE_SHEETS_URL + '?' + params.toString();
                    console.log('Enviado con m√©todo alternativo');
                    return true;
                } catch (e) {
                    console.error('Error en fallback:', e);

                    // Guardar localmente para sincronizar despu√©s
                    const pendingData = JSON.parse(localStorage.getItem('celebralope_pending_' + sheetName) || '[]');
                    pendingData.push({ ...data, _timestamp: new Date().toISOString() });
                    localStorage.setItem('celebralope_pending_' + sheetName, JSON.stringify(pendingData));
                    console.log('Guardado localmente para sincronizar despu√©s');
                    return false;
                }
            }
        }
    </script>

    <!-- Analytics -->
    <script src="../js/analytics.js"></script>

    <!-- Scripts -->
    <script src="../js/data/locales.js"></script>
    <script src="../js/data/servicios.js"></script>
    <script src="../js/utils/helpers.js"></script>
    <script src="../js/components/header.js"></script>
    <script src="../js/components/chatbot.js"></script>
    <script src="../js/components/auth.js"></script>
    <script src="../js/components/cards.js"></script>
    <script src="../js/components/toast.js"></script>
    <script src="../js/components/user.js"></script>
    <script src="../js/components/calendar.js"></script>
    <script src="../js/components/reservations.js"></script>
    <script src="../js/app.js"></script>

    <script>
        let currentLocale = null;

        document.addEventListener('DOMContentLoaded', () => {
            const slug = getUrlParam('slug');
            if (slug) {
                loadLocaleDetail(slug);
            } else {
                // Default to first locale
                loadLocaleDetail(LOCALES_DATA[0].slug);
            }
        });

        function loadLocaleDetail(slug) {
            currentLocale = getLocaleBySlug(slug);

            if (!currentLocale) {
                showToast('error', 'Error', 'Local no encontrado');
                window.location.href = 'locales.html';
                return;
            }

            // Update page title
            document.title = `${currentLocale.name} | Cel√©bralo pe`;

            // Render sections
            renderGallery();
            renderMainContent();
            renderBookingCard();
            initCalendar();

            // Inicializar mapa y rese√±as despu√©s de renderizar
            setTimeout(() => {
                initMap();
                renderReviewsSection();
                updateFavoriteButton();
            }, 100);

            // Track recently viewed
            if (window.userManager) {
                userManager.addToRecentlyViewed({
                    id: currentLocale.id,
                    slug: currentLocale.slug,
                    name: currentLocale.name,
                    icon: currentLocale.icon,
                    rating: currentLocale.rating,
                    price: currentLocale.price.base
                }, 'locales');
            }
        }

        function initCalendar() {
            if (!currentLocale.availability) return;

            localeCalendar = new EventCalendar('#bookingCalendar', {
                availability: currentLocale.availability,
                blockedDates: currentLocale.blockedDates || [],
                showLegend: true,
                onDateSelect: (date, dateStr) => {
                    selectedDate = dateStr;
                    document.getElementById('bookingSelection').style.display = 'block';
                    document.getElementById('selectedDateText').textContent = formatSelectedDate(date);
                    document.getElementById('bookingDate').value = dateStr;
                }
            });
        }

        function formatSelectedDate(date) {
            return date.toLocaleDateString('es-PE', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function renderGallery() {
            const gallery = document.getElementById('galleryGrid');
            gallery.innerHTML = `
                <div class="gallery-main">
                    <div class="placeholder">${currentLocale.icon}</div>
                </div>
                <div class="gallery-side">
                    <div class="gallery-thumb">
                        <div class="placeholder">üéâ</div>
                    </div>
                    <div class="gallery-thumb">
                        <div class="placeholder">‚ú®</div>
                        <div class="gallery-more">+5 fotos</div>
                    </div>
                </div>
            `;
        }

        function renderMainContent() {
            const main = document.getElementById('localMain');
            const starsHtml = generateStars(currentLocale.rating);
            const days = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
            const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            main.innerHTML = `
                <!-- Header -->
                <div class="local-header">
                    <div class="local-badges">
                        ${currentLocale.badges.map(badge => `<span class="badge badge-${badge === 'Verificado' ? 'success' : 'primary'}">${badge}</span>`).join('')}
                    </div>
                    <h1 class="local-title">${currentLocale.name}</h1>
                    <p class="local-location">
                        <i class="fas fa-map-marker-alt"></i>
                        ${currentLocale.location.address}, ${currentLocale.location.district}, ${currentLocale.location.city}
                    </p>
                    <div class="local-meta">
                        <div class="meta-item">
                            <i class="fas fa-users"></i>
                            <div>
                                <strong>${currentLocale.capacity.min}-${currentLocale.capacity.max}</strong>
                                <span>personas</span>
                            </div>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-star"></i>
                            <div>
                                <strong>${currentLocale.rating}</strong>
                                <span>(${currentLocale.reviewsCount} rese√±as)</span>
                            </div>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-tag"></i>
                            <div>
                                <strong>${LOCALE_CATEGORIES[currentLocale.category]?.name || currentLocale.category}</strong>
                                <span>categor√≠a</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <section class="info-section">
                    <h2><i class="fas fa-info-circle"></i> Descripci√≥n</h2>
                    <p class="description">${currentLocale.description}</p>
                </section>

                <!-- Amenities -->
                <section class="info-section">
                    <h2><i class="fas fa-check-circle"></i> Servicios Incluidos</h2>
                    <div class="amenities-grid">
                        ${currentLocale.amenities.map(amenity => `
                            <div class="amenity-item">
                                <i class="fas ${amenity.icon}"></i>
                                <span>${amenity.name}</span>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <!-- Availability -->
                <section class="info-section">
                    <h2><i class="fas fa-calendar-alt"></i> Disponibilidad</h2>
                    <div class="availability-grid">
                        ${dayKeys.map((day, i) => {
                            const avail = currentLocale.availability[day];
                            return `
                                <div class="day-slot ${avail.available ? 'available' : 'unavailable'}">
                                    <span class="day-name">${days[i]}</span>
                                    <span class="hours">${avail.available ? avail.hours : 'Cerrado'}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </section>

                <!-- Event Types -->
                <section class="info-section">
                    <h2><i class="fas fa-calendar-check"></i> Ideal para</h2>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2);">
                        ${currentLocale.eventTypes.map(type => {
                            const eventInfo = EVENT_TYPES[type] || { name: type, icon: 'üéâ' };
                            return `<span class="badge badge-primary">${eventInfo.icon} ${eventInfo.name}</span>`;
                        }).join('')}
                    </div>
                </section>

                <!-- Policies -->
                <section class="info-section">
                    <h2><i class="fas fa-file-contract"></i> Pol√≠ticas</h2>
                    <div class="policies-list">
                        <div class="policy-item">
                            <i class="fas fa-undo"></i>
                            <p><strong>Cancelaci√≥n:</strong> ${currentLocale.policies.cancellation}</p>
                        </div>
                        <div class="policy-item">
                            <i class="fas fa-money-bill"></i>
                            <p><strong>Pago:</strong> ${currentLocale.policies.deposit}</p>
                        </div>
                        ${currentLocale.policies.rules.map(rule => `
                            <div class="policy-item">
                                <i class="fas fa-check"></i>
                                <p>${rule}</p>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <!-- Mapa Interactivo -->
                <section class="info-section map-section">
                    <h2><i class="fas fa-map-marked-alt"></i> Ubicaci√≥n</h2>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
                        <i class="fas fa-map-marker-alt" style="color: var(--primary);"></i>
                        ${currentLocale.location.address}, ${currentLocale.location.district}, ${currentLocale.location.city}
                    </p>
                    <div class="map-container" id="localMap"></div>
                    <div class="map-actions">
                        <button class="btn btn-primary" onclick="openInGoogleMaps()">
                            <i class="fas fa-directions"></i> Google Maps
                        </button>
                        <button class="btn btn-outline" onclick="openInWaze()">
                            <i class="fas fa-car"></i> Waze
                        </button>
                    </div>
                </section>

                <!-- Reviews (Contenedor din√°mico) -->
                <section class="info-section" id="reviewsContainer">
                    <!-- Las rese√±as se cargan din√°micamente con renderReviewsSection() -->
                </section>

                <!-- Owner -->
                <div class="owner-card">
                    <div class="owner-header">
                        <div class="owner-avatar">${currentLocale.owner.avatar}</div>
                        <div class="owner-info">
                            <h4>${currentLocale.owner.name}</h4>
                            <p>Propietario del local</p>
                        </div>
                    </div>
                    <div class="owner-stats">
                        <div>
                            <strong>${currentLocale.owner.responseRate}%</strong>
                            <span>Respuesta</span>
                        </div>
                        <div>
                            <strong>${currentLocale.owner.responseTime}</strong>
                            <span>Tiempo respuesta</span>
                        </div>
                        <div>
                            <strong>${currentLocale.reviewsCount}</strong>
                            <span>Rese√±as</span>
                        </div>
                    </div>
                    <button class="btn btn-outline btn-block" onclick="contactOwner()">
                        <i class="fas fa-comments"></i> Contactar v√≠a plataforma
                    </button>
                </div>
            `;
        }

        let localeCalendar = null;
        let selectedDate = null;

        function renderBookingCard() {
            const card = document.getElementById('bookingCard');
            const minDate = new Date().toISOString().split('T')[0];

            card.innerHTML = `
                <div class="booking-price">
                    <span class="amount">${formatPrice(currentLocale.price.base)}</span>
                    <span class="note">por evento</span>
                </div>

                <!-- Interactive Calendar -->
                <div class="booking-calendar" id="bookingCalendar"></div>

                <div class="booking-selection" id="bookingSelection" style="display: none;">
                    <div class="selection-item" style="display: flex; align-items: center; gap: 10px; background: var(--success-50); padding: 12px; border-radius: 8px; color: var(--success); font-weight: 500;">
                        <i class="fas fa-calendar-check"></i>
                        <span id="selectedDateText">Selecciona una fecha</span>
                    </div>
                </div>

                <form class="booking-form" id="bookingForm" onsubmit="handleBooking(event)">
                    <input type="hidden" id="bookingDate" value="">


                    <div class="form-group">
                        <label>Tipo de evento</label>
                        <select id="bookingEventType" required>
                            <option value="">Selecciona...</option>
                            ${currentLocale.eventTypes.map(type => {
                                const info = EVENT_TYPES[type] || { name: type, icon: 'üéâ' };
                                return `<option value="${type}">${info.icon} ${info.name}</option>`;
                            }).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>N√∫mero de invitados</label>
                        <input type="number" id="bookingGuests" min="${currentLocale.capacity.min}" max="${currentLocale.capacity.max}" placeholder="${currentLocale.capacity.min}-${currentLocale.capacity.max}" required>
                    </div>

                    <div class="price-breakdown">
                        <div class="price-row">
                            <span>Alquiler del local</span>
                            <span>${formatPrice(currentLocale.price.base)}</span>
                        </div>
                        <div class="price-row">
                            <span>Dep√≥sito de garant√≠a</span>
                            <span>${formatPrice(currentLocale.price.deposit)}</span>
                        </div>
                        <div class="price-row">
                            <span>Comisi√≥n Cel√©bralo pe</span>
                            <span>${formatPrice(currentLocale.price.base * 0.12)}</span>
                        </div>
                        <div class="price-row total">
                            <span>Total</span>
                            <span>${formatPrice(currentLocale.price.base + currentLocale.price.deposit + currentLocale.price.base * 0.12)}</span>
                        </div>
                    </div>

                    <div class="booking-actions">
                        <button type="submit" class="btn btn-primary btn-lg btn-block">
                            <i class="fas fa-calendar-check"></i>
                            Reservar Ahora
                        </button>
                        <button type="button" class="btn btn-outline btn-block" onclick="requestVisit()">
                            <i class="fas fa-eye"></i>
                            Solicitar Visita
                        </button>
                    </div>
                </form>

                <div class="share-actions">
                    <button onclick="shareLocal()" title="Compartir">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button onclick="toggleFavoriteLocal()" title="Guardar" id="favBtn">
                        <i class="far fa-heart"></i>
                    </button>
                    <button onclick="printLocal()" title="Imprimir">
                        <i class="fas fa-print"></i>
                    </button>
                </div>

                <p style="text-align: center; font-size: var(--font-size-xs); color: var(--text-muted); margin-top: var(--spacing-4);">
                    <i class="fas fa-shield-alt"></i> Pago seguro con garant√≠a de devoluci√≥n
                </p>
            `;
        }

        // Variables para almacenar datos de reserva temporalmente
        let pendingBookingData = {};

        function handleBooking(e) {
            e.preventDefault();

            const date = document.getElementById('bookingDate').value;
            const eventType = document.getElementById('bookingEventType').value;
            const guests = document.getElementById('bookingGuests').value;

            if (!date) {
                showToast('error', 'Fecha requerida', 'Selecciona una fecha para tu evento');
                return;
            }

            // Guardar datos temporalmente
            const total = currentLocale.price.base + currentLocale.price.deposit + (currentLocale.price.base * 0.12);
            pendingBookingData = {
                local: currentLocale.name,
                localSlug: currentLocale.slug,
                fecha: date,
                fechaFormateada: formatDate(date, 'long'),
                tipoEvento: eventType,
                tipoEventoNombre: EVENT_TYPES[eventType]?.name || eventType,
                invitados: guests,
                precioBase: currentLocale.price.base,
                deposito: currentLocale.price.deposit,
                total: total
            };

            // Llenar el modal con los datos
            document.getElementById('modalLocalName').textContent = currentLocale.name;
            document.getElementById('modalDate').textContent = formatDate(date, 'long');
            document.getElementById('modalGuests').textContent = guests;
            document.getElementById('modalEventType').textContent = EVENT_TYPES[eventType]?.name || eventType;
            document.getElementById('modalTotal').textContent = formatPrice(total);

            // Abrir modal
            openBookingModal();
        }

        function openBookingModal() {
            document.getElementById('bookingModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function submitBookingRequest(e) {
            e.preventDefault();

            const btn = document.getElementById('submitBookingBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            btn.disabled = true;

            const formData = {
                id: 'RES-' + Date.now(),
                nombre: document.getElementById('bookingName').value,
                telefono: document.getElementById('bookingPhone').value,
                contacto: document.getElementById('bookingEmail').value,
                mensaje: document.getElementById('bookingMessage').value || '',
                local: pendingBookingData.local,
                localSlug: pendingBookingData.localSlug,
                fechaEvento: pendingBookingData.fecha,
                tipoEvento: pendingBookingData.tipoEventoNombre,
                invitados: pendingBookingData.invitados,
                precioEstimado: pendingBookingData.total,
                estado: 'pendiente',
                origen: 'web',
                fecha: new Date().toLocaleDateString('es-PE'),
                hora: new Date().toLocaleTimeString('es-PE'),
                timestamp: new Date().toISOString()
            };

            try {
                await sendToGoogleSheets('Reservas', formData);

                closeBookingModal();
                showToast('success', '¬°Solicitud enviada!', 'Te contactaremos en menos de 24 horas para confirmar tu reserva');

                // Limpiar formulario
                document.getElementById('bookingRequestForm').reset();

            } catch (error) {
                console.error('Error al enviar:', error);
                showToast('error', 'Error', 'Hubo un problema. Intenta de nuevo o usa el chat de la plataforma.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function contactOwner() {
            // Abrir chat en modo propietario
            if (window.eventBot && window.eventBot.currentOwner) {
                window.eventBot.switchToOwnerMode();
            } else if (window.eventBot) {
                window.eventBot.open();
                showToast('info', 'Contacto', `Para consultas sobre "${currentLocale.name}", usa nuestro chat.`);
            } else {
                showToast('info', 'Contacto', 'Por favor usa el chat de la plataforma para contactar al proveedor.');
            }
        }

        function openVisitModal() {
            document.getElementById('visitModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeVisitModal() {
            document.getElementById('visitModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function requestVisit() {
            openVisitModal();
        }

        async function submitVisitRequest(e) {
            e.preventDefault();

            const btn = document.getElementById('submitVisitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            btn.disabled = true;

            const userEmail = document.getElementById('visitEmail').value;
            const userName = document.getElementById('visitName').value;
            const userPhone = document.getElementById('visitPhone').value;
            const preferredDate = document.getElementById('visitPreferredDate').value || 'Por definir';

            const formData = {
                id: 'VIS-' + Date.now(),
                nombre: userName,
                telefono: userPhone,
                contacto: userEmail,
                email: userEmail,
                interes: 'Solicitud de visita - ' + currentLocale.name,
                origen: 'Pagina de local',
                campania: 'visita_local',
                fechaPreferida: preferredDate,
                local: currentLocale.name,
                localSlug: currentLocale.slug,
                tipoSolicitud: 'visita',
                estado: 'pendiente',
                fecha: new Date().toLocaleDateString('es-PE'),
                hora: new Date().toLocaleTimeString('es-PE'),
                timestamp: new Date().toISOString()
            };

            try {
                // 1. Enviar a Google Sheets
                await sendToGoogleSheets('Leads', formData);

                // 2. Enviar correo de confirmacion al usuario
                try {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                        to_email: userEmail,
                        to_name: userName,
                        from_name: 'Cel√©bralo pe',
                        subject: 'Solicitud de visita recibida - ' + currentLocale.name,
                        message: `Hola ${userName},\n\nHemos recibido tu solicitud de visita para el local "${currentLocale.name}".\n\nFecha preferida: ${preferredDate}\nTelefono: ${userPhone}\n\nNos pondremos en contacto contigo pronto para coordinar la visita.\n\nGracias por confiar en Cel√©bralo pe.`
                    });
                    console.log('Correo de confirmacion enviado al usuario');
                } catch (emailError) {
                    console.warn('No se pudo enviar correo al usuario:', emailError);
                }

                // 3. Enviar notificacion al administrador
                try {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                        to_email: 'hola@celebralo.pe',
                        to_name: 'Cel√©bralo pe',
                        from_name: userName,
                        subject: 'Nueva solicitud de visita - ' + currentLocale.name,
                        message: `Nueva solicitud de visita:\n\nLocal: ${currentLocale.name}\nNombre: ${userName}\nEmail: ${userEmail}\nTelefono: ${userPhone}\nFecha preferida: ${preferredDate}\n\nFecha de solicitud: ${formData.fecha} ${formData.hora}`
                    });
                    console.log('Notificacion enviada al administrador');
                } catch (emailError) {
                    console.warn('No se pudo enviar notificacion al admin:', emailError);
                }

                closeVisitModal();
                showToast('success', '¬°Solicitud enviada!', 'Te contactaremos pronto para coordinar tu visita');

                // Limpiar formulario
                document.getElementById('visitRequestForm').reset();

            } catch (error) {
                console.error('Error al enviar:', error);
                showToast('error', 'Error', 'Hubo un problema. Intenta de nuevo');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function shareLocal() {
            shareContent(currentLocale.name, currentLocale.shortDescription, window.location.href);
        }

        function toggleFavoriteLocal() {
            const btn = document.getElementById('favBtn');
            const icon = btn.querySelector('i');

            // Usar userManager para guardar correctamente en el historial
            if (window.userManager && currentLocale) {
                const isFavorite = userManager.toggleFavorite(currentLocale.id, 'locales');

                if (isFavorite) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.style.color = 'var(--error)';
                    showToast('success', '‚ù§Ô∏è Guardado', 'Agregado a tus favoritos');

                    // Registrar en Google Sheets
                    if (typeof sendToGoogleSheets === 'function') {
                        sendToGoogleSheets('Feedback', {
                            tipo: 'favorito_agregado',
                            mensaje: `Local: ${currentLocale.name}`,
                            localId: currentLocale.id,
                            localSlug: currentLocale.slug,
                            fecha: new Date().toLocaleDateString('es-PE')
                        });
                    }
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    btn.style.color = '';
                    showToast('info', 'Eliminado', 'Eliminado de favoritos');
                }
            } else {
                // Fallback si userManager no est√° disponible
                const isFavorite = icon.classList.contains('fas');
                if (isFavorite) {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    btn.style.color = '';
                    showToast('info', 'Eliminado', 'Eliminado de favoritos');
                } else {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.style.color = 'var(--error)';
                    showToast('success', '‚ù§Ô∏è Guardado', 'Agregado a favoritos');
                }
            }
        }

        // Actualizar estado del bot√≥n de favoritos al cargar
        function updateFavoriteButton() {
            if (window.userManager && currentLocale) {
                const btn = document.getElementById('favBtn');
                const icon = btn?.querySelector('i');
                if (icon && userManager.isFavorite(currentLocale.id, 'locales')) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.style.color = 'var(--error)';
                }
            }
        }

        function printLocal() {
            window.print();
        }

        // ==========================================
        // MAPA INTERACTIVO CON LEAFLET
        // ==========================================

        let localMap = null;

        function initMap() {
            if (!currentLocale.location || !currentLocale.location.coordinates) {
                console.warn('No hay coordenadas para este local');
                return;
            }

            const { lat, lng } = currentLocale.location.coordinates;

            // Crear mapa
            localMap = L.map('localMap').setView([lat, lng], 16);

            // Agregar capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(localMap);

            // Agregar marcador personalizado
            const customIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: var(--primary, #FF6B35); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${currentLocale.icon || 'üéâ'}</div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });

            const marker = L.marker([lat, lng], { icon: customIcon }).addTo(localMap);

            // Popup del marcador
            marker.bindPopup(`
                <div style="text-align: center; padding: 8px;">
                    <strong style="font-size: 14px;">${currentLocale.name}</strong><br>
                    <span style="font-size: 12px; color: #666;">${currentLocale.location.address}</span><br>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}"
                       target="_blank"
                       style="color: #FF6B35; font-size: 12px; text-decoration: none;">
                       üìç C√≥mo llegar
                    </a>
                </div>
            `).openPopup();
        }

        function openInGoogleMaps() {
            if (!currentLocale.location || !currentLocale.location.coordinates) {
                showToast('error', 'Error', 'No hay ubicaci√≥n disponible');
                return;
            }
            const { lat, lng } = currentLocale.location.coordinates;
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        function openInWaze() {
            if (!currentLocale.location || !currentLocale.location.coordinates) {
                showToast('error', 'Error', 'No hay ubicaci√≥n disponible');
                return;
            }
            const { lat, lng } = currentLocale.location.coordinates;
            const url = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
            window.open(url, '_blank');
        }

        // ==========================================
        // SISTEMA DE RESE√ëAS
        // ==========================================

        const REVIEWS_STORAGE_KEY = 'celebralo_local_reviews';
        let selectedRating = 0;

        function loadLocalReviews() {
            const allReviews = JSON.parse(localStorage.getItem(REVIEWS_STORAGE_KEY) || '{}');
            return allReviews[currentLocale.id] || [];
        }

        function saveLocalReview(review) {
            const allReviews = JSON.parse(localStorage.getItem(REVIEWS_STORAGE_KEY) || '{}');
            if (!allReviews[currentLocale.id]) {
                allReviews[currentLocale.id] = [];
            }
            allReviews[currentLocale.id].unshift(review);
            localStorage.setItem(REVIEWS_STORAGE_KEY, JSON.stringify(allReviews));
        }

        function openReviewModal() {
            // Verificar si el usuario est√° logueado
            const user = window.userManager?.getUserData();
            if (user) {
                document.getElementById('reviewName').value = user.name || '';
                document.getElementById('reviewEmail').value = user.email || '';
            }

            document.getElementById('reviewModalSubtitle').textContent = `Comparte tu experiencia en ${currentLocale.name}`;
            document.getElementById('reviewModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Inicializar estrellas
            initStarRating();
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.remove('active');
            document.body.style.overflow = '';
            selectedRating = 0;
            document.getElementById('reviewForm').reset();
            updateStarDisplay(0);
        }

        function initStarRating() {
            const stars = document.querySelectorAll('#starRatingInput i');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    document.getElementById('reviewRating').value = selectedRating;
                    updateStarDisplay(selectedRating);
                });

                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    updateStarDisplay(rating);
                });
            });

            document.getElementById('starRatingInput').addEventListener('mouseleave', function() {
                updateStarDisplay(selectedRating);
            });
        }

        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('#starRatingInput i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas', 'active');
                } else {
                    star.classList.remove('fas', 'active');
                    star.classList.add('far');
                }
            });
        }

        async function submitReview(e) {
            e.preventDefault();

            if (selectedRating === 0) {
                showToast('warning', 'Calificaci√≥n requerida', 'Por favor selecciona una calificaci√≥n con las estrellas');
                return;
            }

            const btn = document.getElementById('submitReviewBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            btn.disabled = true;

            const review = {
                id: 'REV-' + Date.now(),
                localId: currentLocale.id,
                localName: currentLocale.name,
                rating: selectedRating,
                eventType: document.getElementById('reviewEventType').value,
                comment: document.getElementById('reviewComment').value,
                userName: document.getElementById('reviewName').value,
                userEmail: document.getElementById('reviewEmail').value,
                userAvatar: document.getElementById('reviewName').value.charAt(0).toUpperCase(),
                date: new Date().toISOString(),
                verified: false,
                helpful: 0
            };

            try {
                // Guardar localmente
                saveLocalReview(review);

                // Enviar a Google Sheets
                if (typeof sendToGoogleSheets === 'function') {
                    await sendToGoogleSheets('Feedback', {
                        id: review.id,
                        tipo: 'resena',
                        local: currentLocale.name,
                        localId: currentLocale.id,
                        calificacion: review.rating,
                        tipoEvento: review.eventType,
                        mensaje: review.comment,
                        nombre: review.userName,
                        email: review.userEmail,
                        fecha: new Date().toLocaleDateString('es-PE'),
                        timestamp: new Date().toISOString()
                    });
                }

                closeReviewModal();
                showToast('success', '¬°Gracias por tu rese√±a!', 'Tu opini√≥n ayuda a otros usuarios a tomar mejores decisiones');

                // Actualizar la secci√≥n de rese√±as
                renderReviewsSection();

            } catch (error) {
                console.error('Error al enviar rese√±a:', error);
                showToast('error', 'Error', 'No se pudo enviar la rese√±a. Intenta de nuevo.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function renderReviewsSection() {
            const reviewsContainer = document.getElementById('reviewsContainer');
            if (!reviewsContainer) return;

            const userReviews = loadLocalReviews();
            const allReviews = [...userReviews, ...(currentLocale.reviews || [])];
            const totalReviews = allReviews.length;

            // Calcular promedio
            let avgRating = currentLocale.rating;
            if (userReviews.length > 0) {
                const sum = allReviews.reduce((acc, r) => acc + r.rating, 0);
                avgRating = (sum / totalReviews).toFixed(1);
            }

            const starsHtml = generateStars(parseFloat(avgRating));

            let html = `
                <div class="reviews-header">
                    <h2><i class="fas fa-star"></i> Rese√±as</h2>
                    <div class="rating-summary">
                        <span class="rating-big">${avgRating}</span>
                        <div class="rating-details">
                            <div class="rating-stars">${starsHtml}</div>
                            <span style="color: var(--text-muted); font-size: var(--font-size-sm);">${totalReviews} rese√±as</span>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n para escribir rese√±a -->
                <div class="write-review-section">
                    <h4>¬øYa celebraste tu evento aqu√≠?</h4>
                    <p>Comparte tu experiencia y ayuda a otros a elegir el mejor local</p>
                    <button class="btn btn-primary" onclick="openReviewModal()">
                        <i class="fas fa-pen"></i> Escribir Rese√±a
                    </button>
                </div>

                <div class="all-reviews-list">
            `;

            // Mostrar rese√±as
            allReviews.slice(0, 5).forEach((review, idx) => {
                const isUserReview = review.id?.startsWith('REV-');
                html += `
                    <div class="review-card ${isUserReview ? 'user-review' : ''}">
                        <div class="review-header">
                            <div class="review-author">
                                <div class="avatar" ${idx % 2 === 1 ? 'style="background: var(--secondary);"' : ''}>${review.userAvatar}</div>
                                <div>
                                    <strong>${review.userName}</strong>
                                    <p style="color: var(--text-muted); font-size: var(--font-size-xs); margin: 0;">
                                        ${review.eventType} - ${formatDate(review.date, 'short')}
                                        ${isUserReview ? '<span style="color: var(--primary);"> (Tu rese√±a)</span>' : ''}
                                    </p>
                                </div>
                            </div>
                            <div class="rating-stars">${generateStars(review.rating)}</div>
                        </div>
                        <p class="review-text">${review.comment}</p>
                        ${review.verified ? '<span style="font-size: 12px; color: var(--success);"><i class="fas fa-check-circle"></i> Compra verificada</span>' : ''}
                        <div class="review-helpful">
                            <span>¬øTe fue √∫til?</span>
                            <button onclick="markHelpful('${review.id || idx}', this)">
                                <i class="far fa-thumbs-up"></i> S√≠
                            </button>
                        </div>
                    </div>
                `;
            });

            if (allReviews.length === 0) {
                html += `
                    <div class="review-card" style="text-align: center; color: var(--text-muted);">
                        <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 8px;"></i>
                        <p>S√© el primero en dejar una rese√±a para este local.</p>
                    </div>
                `;
            }

            html += '</div>';

            if (totalReviews > 5) {
                html += `
                    <button class="btn btn-outline" style="margin-top: var(--spacing-4);">
                        Ver todas las rese√±as (${totalReviews})
                    </button>
                `;
            }

            reviewsContainer.innerHTML = html;
        }

        function markHelpful(reviewId, btn) {
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
                showToast('info', 'Eliminado', 'Has quitado tu voto');
            } else {
                btn.classList.add('active');
                showToast('success', '¬°Gracias!', 'Tu voto ha sido registrado');
            }
        }

        // ==========================================
        // NOTIFICACI√ìN A PROVEEDOR (Chat mejorado)
        // ==========================================

        function notifyProviderNewMessage(message) {
            // Simular notificaci√≥n al proveedor via Google Sheets
            if (typeof sendToGoogleSheets === 'function' && currentLocale) {
                sendToGoogleSheets('Consultas', {
                    id: 'MSG-' + Date.now(),
                    tipo: 'mensaje_chat',
                    local: currentLocale.name,
                    localId: currentLocale.id,
                    propietario: currentLocale.owner?.name || 'Propietario',
                    mensaje: message,
                    estado: 'pendiente_respuesta',
                    fecha: new Date().toLocaleDateString('es-PE'),
                    hora: new Date().toLocaleTimeString('es-PE'),
                    timestamp: new Date().toISOString()
                });
            }
        }
    </script>

    <!-- Leaflet JS para mapa interactivo -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</body>
</html>
